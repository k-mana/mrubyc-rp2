// SPDX-License-Identifier: BSD-3-Clause

#include <stdint.h>
#include "mrubyc.h"
#include "pico/stdlib.h"

#define MEMORY_SIZE (100 * 1024)

/*
```code.rb
loop do
  led_write 1
  sleep 1
  led_write 0
  sleep 1
end
```
$ mrbc -Bbytecode -o bytecode.c code.rb
*/
static const uint8_t bytecode[] = {
0x52,0x49,0x54,0x45,0x30,0x33,0x30,0x30,0x00,0x00,0x00,0xa1,0x4d,0x41,0x54,0x5a,
0x30,0x30,0x30,0x30,0x49,0x52,0x45,0x50,0x00,0x00,0x00,0x77,0x30,0x33,0x30,0x30,
0x00,0x00,0x00,0x25,0x00,0x01,0x00,0x03,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x0a,
0x57,0x02,0x00,0x2e,0x01,0x00,0x00,0x38,0x01,0x69,0x00,0x00,0x00,0x01,0x00,0x04,
0x6c,0x6f,0x6f,0x70,0x00,0x00,0x00,0x00,0x46,0x00,0x02,0x00,0x05,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x1e,0x34,0x00,0x00,0x00,0x07,0x03,0x2d,0x02,0x00,0x01,0x07,
0x03,0x2d,0x02,0x01,0x01,0x06,0x03,0x2d,0x02,0x00,0x01,0x07,0x03,0x2d,0x02,0x01,
0x01,0x38,0x02,0x00,0x00,0x00,0x02,0x00,0x09,0x6c,0x65,0x64,0x5f,0x77,0x72,0x69,
0x74,0x65,0x00,0x00,0x05,0x73,0x6c,0x65,0x65,0x70,0x00,0x4c,0x56,0x41,0x52,0x00,
0x00,0x00,0x0e,0x00,0x00,0x00,0x00,0xff,0xff,0x45,0x4e,0x44,0x00,0x00,0x00,0x00,
0x08,
};

static uint8_t memory_pool[MEMORY_SIZE];
static const uint LED_PIN = PICO_DEFAULT_LED_PIN;

static void c_led_write(mrb_vm *vm, mrb_value *v, int argc)
{
  int set_value = GET_INT_ARG(1);
  gpio_put(LED_PIN, set_value);
}

int main()
{
  stdio_init_all();
  gpio_init(LED_PIN);
  gpio_set_dir(LED_PIN, GPIO_OUT);

  mrbc_init(memory_pool, MEMORY_SIZE);
  mrbc_define_method(0, mrbc_class_object, "led_write", c_led_write);
  mrbc_create_task(bytecode, 0);
  mrbc_run();

  return 0;
}
